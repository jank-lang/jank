;; Comprehensive tests for try-catch-finally execution order

;; Test 1: Basic try-catch-finally order
(let [execution-order (atom [])]
  (try
    (swap! execution-order conj :try)
    (throw :exception)
    (catch cpp/jank.runtime.object_ref e1
      (swap! execution-order conj :catch))
    (finally
      (swap! execution-order conj :finally)))
  (assert (= [:try :catch :finally] @execution-order) "Basic execution order failed"))

;; Test 2: Finally executes after catch returns value
(let [cleanup (atom false)]
  (assert
   (= :caught
      (try
        (throw "error")
        (catch cpp/jank.runtime.object_ref e :caught)
        (finally
          (reset! cleanup true)))))
  (assert (true? @cleanup) "Finally block did not execute"))

;; Test 3: Nested try with finally - inner finally executes before outer catch
(let* [finally-executed (atom false)
       caught-exception (try
                          (try
                            (throw "inner-throw")
                            (finally (reset! finally-executed true)))
                          (catch cpp/jank.runtime.object_ref e e))]
  (assert @finally-executed "Inner finally should have executed before outer catch")
  (assert (= "inner-throw" caught-exception)
          (str "Expected 'inner-throw' but got: " caught-exception)))

:success
