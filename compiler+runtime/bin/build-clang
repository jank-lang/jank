#!/usr/bin/env bash

set -euo pipefail

here="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
build_dir="${here}/../build"
mkdir -p "${build_dir}"
cd "${build_dir}"

# We build Clang with Clang for consistency.
export CC=clang
export CXX=clang++

set +e
  make_j="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu 2>/dev/null || echo 4)"
set -e

update=0

while getopts ":huj:" opt; do
  case "${opt}" in
    h)
      echo "Usage ${0} [-j N] [-u] [srcdir]"
      exit 0
      ;;
    j)
      make_j="${OPTARG}"
      ;;
    u)
      update=1
      ;;
    \?)
      echo "Invalid option: ${OPTARG}" 1>&2
      exit 1
      ;;
    :)
      echo "Invalid option: ${OPTARG} requires an argument" 1>&2
      exit 1
      ;;
    *)
      echo "Unexpected input: ${OPTARG}" 1>&2
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

echo "Using ${make_j} cores to build"

srcdir="${PWD}"

llvm_url="https://github.com/jank-lang/llvm-project.git"
llvm_branch="jank"

function prepare()
{
  if [[ ! -d "${srcdir}/llvm" ]];
  then
    git clone -b "${llvm_branch}" --depth 1 --shallow-submodules --single-branch "${llvm_url}" "${srcdir}"/llvm
  elif [[ ${update} == 1 ]];
  then
    cd "${srcdir}"/llvm
      git checkout "${llvm_branch}"
      git pull origin "${llvm_branch}"
    cd -
  fi
}

function build()
{
  mkdir -p "${srcdir}/llvm-build"
  cd "${srcdir}/llvm-build"

  cmake -DCMAKE_BUILD_TYPE=Release \
        -DLLVM_ENABLE_RUNTIMES=all \
        -DLLVM_BUILD_LLVM_DYLIB=ON \
        -DLLVM_LINK_LLVM_DYLIB=ON \
        -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;compiler-rt" \
        -DLLVM_TARGETS_TO_BUILD="host" \
        -DLLVM_ENABLE_EH=ON \
        -DLLVM_ENABLE_RTTI=ON \
        -DLLVM_INCLUDE_BENCHMARKS=OFF \
        -DLLVM_ENABLE_BINDINGS=OFF \
        -DLLVM_INCLUDE_EXAMPLES=OFF \
        -DLLVM_INCLUDE_TESTS=OFF \
        -DLLVM_ENABLE_ZSTD=OFF \
        -DLLVM_BUILD_OCAML_BINDINGS=OFF \
        -DLLVM_ENABLE_OCAMLDOC=OFF \
        -G "Ninja" \
        ../llvm/llvm

  DESTDIR="${srcdir}/llvm-install" ninja clang clang-repl clang-cpp clang-tidy install -j"${make_j}"
}

prepare
build

echo
echo "Clang/LLVM successfully compiled. You can now build jank."
